<form [formGroup]="reservarForm" (ngSubmit)="reservarCita()" class="reserva-form">

  <!-- Cliente (solo si rol es admin) -->
  <mat-form-field appearance="fill" class="full-width" *ngIf="esAdmin">
    <mat-label>Cliente</mat-label>
    <mat-select formControlName="cliente">
      <mat-option *ngFor="let c of clientes" [value]="c._id">
        {{ c?.usuario?.nombre || 'Sin nombre' }}
      </mat-option>
    </mat-select>
    <mat-error *ngIf="reservarForm.get('cliente')?.hasError('required')">
      El cliente es obligatorio
    </mat-error>
  </mat-form-field>

  <!-- Sede -->
  <mat-form-field appearance="fill" class="full-width">
    <mat-label>Sede</mat-label>
    <mat-select formControlName="sede" (selectionChange)="onSedeChange($event.value)">
      <mat-option *ngFor="let s of sedes" [value]="s._id">
        {{ s?.nombre || 'Sin nombre' }}
      </mat-option>
    </mat-select>
    <mat-error *ngIf="reservarForm.get('sede')?.hasError('required')">
      La sede es obligatoria
    </mat-error>
  </mat-form-field>

  <!-- Peluquero -->
  <mat-form-field appearance="fill" class="full-width">
    <mat-label>Peluquero</mat-label>
    <mat-select formControlName="peluquero" (selectionChange)="onPeluqueroChange($event.value)">
      <mat-option *ngFor="let p of peluquerosDropdown" [value]="p._id" [disabled]="p?.ocupado">
        {{ p?.nombre || 'Sin nombre' }}
        <mat-icon *ngIf="p?.ocupado" color="warn" matTooltip="Ocupado" class="ml-2">lock</mat-icon>
      </mat-option>
    </mat-select>
    <mat-error *ngIf="reservarForm.get('peluquero')?.hasError('required')">
      El peluquero es obligatorio
    </mat-error>
  </mat-form-field>

  <!-- Puesto de Trabajo (solo lectura) -->
  <mat-form-field appearance="fill" class="full-width">
    <mat-label>Puesto de Trabajo</mat-label>
    <input matInput [value]="puestoSeleccionado?.nombre" disabled>
    <mat-error *ngIf="reservarForm.get('puestoTrabajo')?.hasError('required')">
      El puesto de trabajo es obligatorio
    </mat-error>
  </mat-form-field>

  <!-- Campo oculto para enviar el _id -->
  <input type="hidden" formControlName="puestoTrabajo">

  <!-- Fecha -->
  <mat-form-field appearance="fill" class="full-width">
    <mat-label>Fecha</mat-label>
    <input 
      matInput 
      [matDatepicker]="picker" 
      formControlName="fecha" 
      (dateChange)="validarFechaHoraYActualizarOcupacion()"
    >
    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
    <mat-error *ngIf="reservarForm.get('fecha')?.hasError('required')">
      La fecha es obligatoria
    </mat-error>
    <mat-error *ngIf="fechaHoraInvalida">
      La fecha u hora seleccionada ya está ocupada
    </mat-error>
  </mat-form-field>

  <!-- Hora -->
  <mat-form-field appearance="fill" class="full-width">
    <mat-label>Hora</mat-label>
    <input 
      matInput 
      type="time" 
      formControlName="hora" 
      (change)="validarFechaHoraYActualizarOcupacion()"
    >
    <mat-error *ngIf="reservarForm.get('hora')?.hasError('required')">
      La hora es obligatoria
    </mat-error>
    <mat-error *ngIf="fechaHoraInvalida">
      La hora seleccionada ya está ocupada en esta sede
    </mat-error>
  </mat-form-field>

  <!-- Servicios -->
  <label class="servicios-label">Servicios</label>

  <div class="servicios-container">
    <!-- Reemplazamos mat-selection-list por un listado controlado -->
    <div class="servicio-row" *ngFor="let s of servicios">
      <div
        class="servicio-card"
        [class.selected]="isServicioSelected(s._id)"
        (click)="toggleServicioOnCard(s._id, $event)"
        role="button"
        tabindex="0"
        (keydown.enter)="toggleServicioOnCard(s._id, $event)"
        (keydown.space)="toggleServicioOnCard(s._id, $event)"
      >
        <div class="servicio-info">
          <span class="nombre">{{ s?.nombre || 'Sin nombre' }}</span>
          <span class="detalles">{{ s?.duracion || 0 }} min · ${{ s?.precio || 0 }}</span>
        </div>

        <div class="servicio-actions">
          <button
            mat-icon-button
            color="primary"
            (click)="verDetalleServicio(s); $event.stopPropagation()"
            matTooltip="Ver detalles"
            type="button"
            aria-label="Ver detalles servicio"
          >
            <mat-icon>info</mat-icon>
          </button>

          <!-- Checkbox con disableRipple para evitar cualquier óvalo -->
          <mat-checkbox
            class="servicio-checkbox"
            disableRipple
            [checked]="isServicioSelected(s._id)"
            (change)="toggleServicio(s._id, $event)"
            (click)="$event.stopPropagation()"
            aria-label="Seleccionar servicio"
          >
          </mat-checkbox>
        </div>
      </div>
    </div>
  </div>

  <mat-error *ngIf="serviciosArray.invalid || serviciosArray.length === 0">
    Debes seleccionar al menos un servicio
  </mat-error>

  <!-- Observaciones -->
  <mat-form-field appearance="fill" class="full-width">
    <mat-label>Observaciones</mat-label>
    <textarea matInput formControlName="observaciones" rows="3"></textarea>
  </mat-form-field>

  <!-- Botones -->
  <div class="botones">
    <button 
      mat-raised-button 
      color="primary" 
      type="submit" 
      [disabled]="reservarForm.invalid || fechaHoraInvalida || loading"
    >
      Reservar Cita
    </button>
    <button 
      mat-raised-button 
      color="warn" 
      type="button" 
      (click)="cancelarCita()"
    >
      Cancelar
    </button>
  </div>

</form>
