<h2 mat-dialog-title>{{ titulo }}</h2>

<mat-dialog-content [formGroup]="usuarioForm">
  <!-- Datos básicos -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Nombre -->
    <mat-form-field appearance="outline">
      <mat-label>Nombre</mat-label>
      <input matInput formControlName="nombre" />
      <mat-error *ngIf="usuarioForm.get('nombre')?.hasError('required')">Nombre es obligatorio</mat-error>
      <mat-error *ngIf="usuarioForm.get('nombre')?.hasError('pattern')">Solo letras mínimo 3</mat-error>
    </mat-form-field>

    <!-- Correo -->
    <mat-form-field appearance="outline">
      <mat-label>Correo</mat-label>
      <input matInput formControlName="correo" />
      <mat-error *ngIf="usuarioForm.get('correo')?.hasError('required')">Correo es obligatorio</mat-error>
      <mat-error *ngIf="usuarioForm.get('correo')?.hasError('email')">Correo no válido</mat-error>
      <mat-error *ngIf="usuarioForm.get('correo')?.hasError('emailExiste')">El correo ya existe</mat-error>
    </mat-form-field>

    <!-- Contraseña -->
    <mat-form-field appearance="outline">
      <mat-label>Contraseña</mat-label>
      <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="password" />
      <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword"
        [attr.aria-label]="'Toggle password visibility'"
        [attr.aria-pressed]="!hidePassword">
        <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
      </button>
      <mat-error *ngIf="usuarioForm.get('password')?.hasError('required') && modo === 'crear'">Contraseña obligatoria</mat-error>
      <mat-error *ngIf="usuarioForm.get('password')?.hasError('passwordSegura')">
        Debe tener mayúscula, minúscula, número y símbolo
      </mat-error>
    </mat-form-field>

    <!-- Confirmar Contraseña -->
    <mat-form-field appearance="outline">
      <mat-label>Confirmar Contraseña</mat-label>
      <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirmarPassword" />
      <button mat-icon-button matSuffix (click)="hideConfirmPassword = !hideConfirmPassword"
        [attr.aria-label]="'Toggle confirm password visibility'"
        [attr.aria-pressed]="!hideConfirmPassword">
        <mat-icon>{{ hideConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
      </button>
      <mat-error *ngIf="usuarioForm.hasError('noCoinciden')">Las contraseñas no coinciden</mat-error>
    </mat-form-field>

    <!-- Rol -->
    <mat-form-field appearance="outline">
      <mat-label>Rol</mat-label>
      <mat-select formControlName="rol">
        <mat-option *ngFor="let rol of roles" [value]="rol._id">{{ rol.nombre }}</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Estado -->
    <div class="col-span-full">
      <mat-slide-toggle formControlName="estado">Activo</mat-slide-toggle>
    </div>
  </div>

  <!-- Datos Cliente -->
  <div *ngIf="mostrarCamposCliente" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
    <h3 class="col-span-full text-lg font-semibold">Datos Cliente</h3>

    <mat-form-field appearance="outline">
      <mat-label>Teléfono</mat-label>
      <input matInput formControlName="telefono" />
      <mat-error *ngIf="usuarioForm.get('telefono')?.hasError('telefonoInvalido')">Teléfono debe tener 10 dígitos</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Dirección</mat-label>
      <input matInput formControlName="direccion" />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Género</mat-label>
      <mat-select formControlName="genero">
        <mat-option value="masculino">Masculino</mat-option>
        <mat-option value="femenino">Femenino</mat-option>
        <mat-option value="otro">Otro</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Fecha Nacimiento</mat-label>
      <input matInput [matDatepicker]="pickerCliente" formControlName="fecha_nacimiento" />
      <mat-datepicker-toggle matSuffix [for]="pickerCliente"></mat-datepicker-toggle>
      <mat-datepicker #pickerCliente startView="multi-year" panelClass="es-datepicker"></mat-datepicker>
    </mat-form-field>
  </div>

  <!-- Datos Peluquero -->
  <div *ngIf="mostrarCamposPeluquero" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
    <h3 class="col-span-full text-lg font-semibold">Datos Peluquero</h3>

    <mat-form-field appearance="outline">
      <mat-label>Teléfono Profesional</mat-label>
      <input matInput formControlName="telefono" />
      <mat-error *ngIf="usuarioForm.get('telefono')?.hasError('telefonoInvalido')">
        Teléfono debe tener 10 dígitos
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Dirección Profesional</mat-label>
      <input matInput formControlName="direccion" />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Género</mat-label>
      <mat-select formControlName="genero">
        <mat-option value="masculino">Masculino</mat-option>
        <mat-option value="femenino">Femenino</mat-option>
        <mat-option value="otro">Otro</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Fecha Nacimiento</mat-label>
      <input matInput [matDatepicker]="pickerPeluquero" formControlName="fecha_nacimiento" />
      <mat-datepicker-toggle matSuffix [for]="pickerPeluquero"></mat-datepicker-toggle>
      <mat-datepicker #pickerPeluquero startView="multi-year" panelClass="es-datepicker"></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Especialidades</mat-label>
      <input matInput formControlName="especialidades" placeholder="Corte, Barba, Coloración" />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Experiencia (años)</mat-label>
      <input matInput type="number" formControlName="experiencia" />
      <mat-error *ngIf="usuarioForm.get('experiencia')?.hasError('min')">
        Debe ser mayor o igual a 0
      </mat-error>
      <mat-error *ngIf="usuarioForm.get('experiencia')?.hasError('pattern')">
        Solo números positivos
      </mat-error>
    </mat-form-field>

    <!-- ✅ Sede -->
    <mat-form-field appearance="outline">
      <mat-label>Sede</mat-label>
      <mat-select formControlName="sede" (selectionChange)="cargarPuestosPorSede($event.value)">
        <mat-option *ngFor="let sede of sedes" [value]="sede._id">{{ sede.nombre }}</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- ✅ Puesto de trabajo filtrado por sede -->
    <mat-form-field appearance="outline">
      <mat-label>Puesto de trabajo</mat-label>
      <mat-select formControlName="puestoTrabajo">
        <mat-option *ngFor="let puesto of puestosFiltrados" [value]="puesto._id">
          {{ puesto.nombre }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="usuarioForm.get('puestoTrabajo')?.hasError('required')">
        Debes seleccionar un puesto
      </mat-error>
    </mat-form-field>
  </div>

  <!-- Acciones -->
  <mat-dialog-actions align="end" class="mt-6">
    <button mat-flat-button color="warn" (click)="cerrar()">Cancelar</button>
    <button mat-flat-button color="primary"
      [disabled]="usuarioForm.invalid || !usuarioForm.dirty"
      (click)="guardar()">
      {{ modo === 'crear' ? 'Crear' : 'Actualizar' }}
    </button>
  </mat-dialog-actions>
</mat-dialog-content>
